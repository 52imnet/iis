{{template "header.html" .}}

{{if .User}}

<title>@{{.User.ID}}</title>

    <script>sel('#nav-user-info').className = "selected"</script>

<form method="POST" action="/user">
<table class="articles" style="margin: 0.5em 0">
    <tr>
        <td>用户名:</td>
        <td colspan=2>{{.User.ID}}</td>
    </tr>
    <tr>
        <td>上次登入:</td>
            <td>{{.User.Login.Format "2006-01-02 15:04:05"}}</td>
            <td rowspan=2 class=nowrap>
                <button style="color:#f52" class="gbutton" type=submit name=method value=logout>注销</button>
            </td>
    </tr>
    <tr>
        <td>注册于:</td>
        <td>{{.User.Signup.Format "2006-01-02 15:04:05"}}</td>
    </tr>
    <tr>
        <td class=nowrap>上次登入IP:</td><td colspan=2>{{.User.DataIP}}</td>
    </tr>

    <tr>
        <td class=nowrap>头像URL:</td>
        <td colspan=2> 
            <input type=hidden name=uuid value="{{.UUID}}">
            <input type=hidden name=username value="{{.User.ID}}">
            <input class=t name=avatar value="{{.User.Avatar}}" maxlength=256>
        </td>
    </tr>
    <tr>
        <td class=nowrap>Email:</td>
        <td colspan=2> 
            <input name=email class=t value="{{.User.Email}}" type=email>
        </td>
    </tr>
    <tr>
        <td class=nowrap></td>
        <td colspan=2> 
            <input name=nrit type=checkbox {{if .User.NoReplyInTimeline}}checked{{end}} id=nrit>
            <label for=nrit>不要将我的回复显示在我的时间线中</label>
        </td>
    </tr>
    <tr>
        <td class=nowrap></td>
        <td colspan=2> 
            <input name=npim type=checkbox {{if .User.NoPostInMaster}}checked{{end}} id=npim>
            <label for= npim>不要将我的状态显示在Master时间线中</label>
        </td>
    </tr>
    <tr>
        <td class=nowrap></td>
        <td colspan=2> 
            <input name=autonsfw type=checkbox {{if .User.AutoNSFW}}checked{{end}} id=autonsfw>
            <label for= autonsfw>自动展开NSFW图片</label>
        </td>
    </tr>
    <tr>
        <td colspan=2>
            {{if .EError}}{{template "error_i18n.html" .EError}}{{end}}
        </td>
        <td class=nowrap>
            <button name=method value=update-info class="gbutton" type=submit>更新</button>
        </td>
    </tr>

    {{if .User.IsMod}}
    <tr>
        <td class=nowrap>最大耗时:</td>
        <td>{{.Survey.Max}}ms</td>
    </tr>
    <tr>
        <td class=nowrap>流出流量:</td>
        <td>{{.Survey.Written}}b</td>
    </tr>
    {{end}}

    <tr>
        <td colspan=3><b>修改密码</b></td>
    </tr>
    <tr>
        <td class=nowrap>原密码:</td>
        <td colspan=2><input name=password type=password class=t></td>
    </tr>
    <tr>
        <td class=nowrap>新密码:</td>
        <td colspan=2><input name=new-password type=password class=t></td>
    </tr>
    <tr>
        <td colspan=2></td>
        <td class=nowrap>
            <button name=method value=update-password class="gbutton" type=submit>更新</button>
        </td>
    </tr>
</table>
    </form> 


{{else}}

<title>登入/注册</title>

    <script>sel('#nav-login').className = "selected"</script>
<form method="POST" action="/user">
    <table class="articles">
        <input type=hidden name=uuid value="{{.UUID}}">
        <input type=hidden name=method value="login">
        <tr>
            <td class=nowrap>用户名:</td>
            <td><input autofocus class=t name=username value="{{.RUsername}}" required></td>
        </tr>
        <tr>
            <td class=nowrap>密码:</td>
            <td><input type=password class=t name=password value="{{.RPassword}}" required></td>
        </tr>
        {{if .LoginError}}
        <tr>
            <td></td><td>{{template "error_i18n.html" .LoginError}}</td>
        </tr>
        {{end}}
        <tr>
            <td>
            </td> 
            <td style="text-align:right">
                <button class="gbutton" type=submit>登入</button>
            </td>
        </tr>
</table>
</form>

<form method="POST" action="/user">
    <table class="articles">
    <tr><td colspan=2><hr></td></tr>
    <tr><td colspan=2><b>注册新用户</b></td></tr>

    <input type=hidden name=uuid value="{{.UUID}}">
    <input type=hidden name=method value="signup">
    <tr>
        <td>用户名:</td>
        <td><input class=t maxlength=15 name=username value="{{.RUsername}}" onkeyup="checkID(this.value)"></td>
    <script>
        function checkID(id) {
            var x = [], j = 0, filtered = false;
            for (var i = 0 ; i < id.length; i++) {
                var c = id.charCodeAt(i);
                j++;
                if (j > 15) break
                if (c == 46 || c == 45 || c == 95 || c == 33 || c == 126) x.push(c)
                else if (c >= 48 && c <= 57) x.push(c)
                else if (c >= 65 && c <= 90) x.push(c)
                else if (c >= 97 && c <= 122) x.push(c)
                else if (c >= 0x2000 && c <= 0x9fff) {
                    j++;
                    if (j > 15) break
                    x.push(c);
                } else {
                    filtered = true;
                    x.push(95)
                }
            }
            sel("#id-output").innerHTML = "<b style='font-family:monospace'>" + String.fromCharCode.apply(null, x) +
                (filtered ? "&emsp;<span style='color:#f52'>(注意: 非法字符已过滤)</span></b>" : "</b>");
        }
    </script>
    </tr>
    <tr>
        <td></td><td id="id-output">3~15英文，2~7中文</td>
    </tr>
    <tr>
        <td class=nowrap>密码: </td>
        <td><input type=password class=t name=password value="{{.RPassword}}"></td>
    </tr>
    <tr>
        <td class=nowrap>重复密码:</td>
        <td><input type=password class=t name=password2 value="{{.RPassword}}"></td>
    </tr>
    <tr>
        <td>Email:</td>
        <td><input class=t name=email value="{{.REmail}}"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <button name=refresh value=1 type=submit class=none>
                <img src="data:image/png;base64,{{.Challenge}}">
            </button>
        </td>
    </tr>
    <tr>
        <td class=nowrap>验证码:</td>
        <td><input size=10 name="answer" class=s></td>
    </tr> 
    {{if .EError}}
    <tr>
        <td></td><td>{{template "error_i18n.html" .EError}}</td>
    </tr>
    {{end}}
    <tr>
        <td></td> <td style="text-align:right">
            <button class="gbutton" type=submit>注册</button>
        </td>
    </tr>
</table>
</form>
{{end}}

