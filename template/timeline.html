{{template "header.html" .}}

{{if .IsUserTimeline}}
<div class="status-box">
    <title>@{{.User.ID}} 的时间线</title>

    <div>
    <script>$q('#nav-other a').innerText = "@{{.User.ID}}"; $q('#nav-other').className = "selected"</script>
        {{template "user_public.html" .User}}
    </div>

    {{if .You}}
    <div>
    {{if ne .You.ID .User.ID}}
        {{if .IsUserTimelineFollowed}}
        <button class="gbutton" value onclick="followBlock(this,'follow','{{.User.ID}}')">取消关注</button>
        {{else}}
        <button class="gbutton" value=1 onclick="followBlock(this,'follow','{{.User.ID}}')">关注</button>
        {{end}}

        {{if .IsUserTimelineBlocked}}
        <button class="gbutton" value onclick="followBlock(this,'block','{{.User.ID}}')">解除黑名单</button>
        {{else}}
        <button class="gbutton" value=1 onclick="followBlock(this,'block','{{.User.ID}}')">拉入黑名单</button>
        {{end}}

    {{end}}

    {{if .You.IsAdmin}}
    <a class=gbutton href="/user?as={{.User.ID}}">SWAP</a>
    {{end}}

    {{if .You.IsMod}}
        <button class="gbutton" onclick="$postReload(this,'/api/ban',{to:'{{.User.ID}}'})">
            {{if .User.Banned}}解封{{else}}封禁{{end}}
        </button>
    {{end}}

    </div>

    {{end}}
</div>
{{else if .IsInbox}}
    <title>我的提醒</title>
    <script>$q('#nav-inbox').className = "selected"</script>
{{else if eq .User.ID "master"}}
    <title>全局时间线</title>
    <script>$q('#nav-master').className = "selected"</script>
{{else if .IsUserLikeTimeline}}
<div class="status-box">
        {{template "user_public.html" .User}}
</div>
    <title>@{{.User.ID}}的收藏</title>
    <script>$q('#nav-likes a span').innerText = "@{{.User.ID}}";$q('#nav-likes').className = "selected"</script>
{{else if .IsTagTimeline}}
    <title>#{{.Tag}}</title>
    <script>$q('#nav-other a').innerText = "#{{.Tag}} ({{.PostsUnderTag}})"; $q('#nav-other').className = "selected"</script>

<div class="status-box">
    <div>
        {{if .IsTagTimelineFollowed}}
        <button class="gbutton" value onclick="followBlock(this,'follow','#{{.Tag}}')">取消关注</button>
        {{else}}
        <button class="gbutton" value=1 onclick="followBlock(this,'follow','#{{.Tag}}')">关注</button>
        {{end}}
    </div>
</div>

{{else}}
<div class="status-box">
        <title>我的时间线</title>
    <div>
        <script>$q('#nav-own').className = "selected"</script>
        {{template "user_private.html" .User}}
    </div>
    {{if .ShowNewPost}}
    <div style="padding:0 0.5em">{{template "reply_view.html" .ReplyView}}</div>
    {{end}}
</div>
        {{end}}

<div class="rows" id=timeline>
    {{range .Articles}}
        {{template "row_content.html" .}}
    {{end}}
</div>


<div class=paging>
    {{if .Next}}
    <button id=next value="{{.Next}}" class=gbutton onclick="loadMore(this)">更多...</button>
    <script>
        function loadMore(el) {
            var tl = $q("#timeline"), stop = $wait(el);
            $post('/api/timeline', {
                cursors: el.getAttribute("value"),
                {{if .IsUserLikeTimeline}}likes: 1,{{end}}
            }, function(pl) {
                stop();
                if (pl.EOT) {
                    el.innerText = "没有更多内容了";
                    el.setAttribute("eot", "true");
                    el.style.color = "#aaa";
                    el.onclick = function() { location.reload() }
                } else {
                    el.innerText = "更多...";
                }
                if (pl.Articles) {
                    el.setAttribute("value", pl.Next);
                    pl.Articles.forEach(function(a) {
                        var dedup = $q("[data-id='" + a[0] + "']", true);
                        if (dedup && dedup.length) {
                            console.log("dedup:", a[0])
                            return;
                        }
                        var div = document.createElement("div");
                        div.innerHTML = a[1];
                        tl.appendChild(div.firstChild);
                    })
                }
                expandNSFW();
            }, stop);
         //   console.log(document.documentElement.scrollTop);
        }

        window.addEventListener('scroll', function(e) {
            if (!window.ticking) {
                window.requestAnimationFrame(function() {
                    $q("#timeline .row", true).forEach(function(c) {
                        if (isInViewport(c, 3)) {
                            if (c.childNodes.length == 0) {
                                c.innerHTML = c.__html;
                                c.style.height = "";
                            }
                        } else {
                            if (c.childNodes.length) {
                                c.style.height = c.offsetHeight + "px";
                                c.__html = c.innerHTML;
                                c.innerHTML = "";
                            }
                        }
                    })
                    var nextBtn = $q("#next");
                    if (isInViewport(nextBtn) &&
                        !nextBtn.getAttribute("disabled") && nextBtn.getAttribute("eot") !== "true") {
                        console.log("Load next");
                        nextBtn.click();
                    }
                    window.ticking = false;
                });
                window.ticking = true;
            }
        });
    </script>
    {{else}}
        <a class=gbutton style="color:#aaa"
        {{if .IsUserTimeline}}
            href="/t/{{.User.ID}}">没有更多{{.User.ID}}的状态了</a>
        {{else if .IsInbox}}
            href="/t/:in">没有更多提醒了</a>
        {{else if eq .User.ID "master"}}
            href="/t/master">没有更多状态了</a>
        {{else}}
            href="/t">没有更多状态了</a>
        {{end}}
    {{end}}
</div>
