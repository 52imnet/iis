{{template "header.html" .}}

{{if .IsUserTimeline}}
<div style="text-align:center;line-height:2em">
    <title>@{{.User.ID}} 的时间线</title>

    <div>
    <script>sel('#nav-other a').innerText = "{{.User.ID}}"; sel('#nav-other').className = "selected"</script>
        <div class="status">
            <div class=title>
                <b>@{{.User.ID}}</b>
                {{if .User.IsMod}}<span class=mod>Mod</span>{{end}}
                {{if .User.Banned}}/ 封禁{{end}}
            </div>
            <span><b>{{.User.Followings}}</b><br><span style="color:black">关注</span></span>
            <span><b>{{.User.Followers}}</b><br><span style="color:black">粉丝</span></span>
            <span><b>{{.User.TotalPosts}}</b><br><span style="color:black">状态</span></span>
        </div>
    </div>

    {{if .You}}
    <div>
    {{if ne .You.ID .User.ID}}
    <form method="POST" action="/user" style="display:inline-block">
            <input type=hidden name=uuid value="{{.ReplyView.UUID}}">
            <input type=hidden name=username value="{{.You.ID}}">
            <input type=hidden name=method value="follow">
            <input type=hidden name=to value="{{.User.ID}}">
            {{if .IsUserTimelineFollowed}}
            <button class="gbutton" type=submit>取消关注</button>
            {{else}}
            <input type=hidden name=follow value="1">
            <button class="gbutton" type=submit>关注</button>
            {{end}}
    </form>
    <form method="POST" action="/user" style="display:inline-block">
            <input type=hidden name=uuid value="{{.ReplyView.UUID}}">
            <input type=hidden name=username value="{{.You.ID}}">
            <input type=hidden name=method value="block">
            <input type=hidden name=to value="{{.User.ID}}">
            {{if .IsUserTimelineBlocked}}
            <button class="gbutton" type=submit>解除黑名单</button>
            {{else}}
            <input type=hidden name=block value="1">
            <button class="gbutton" type=submit style="color:#f52">拉入黑名单</button>
            {{end}}
    </form>
    {{end}}

    {{if .You.IsAdmin}}
    <a class=gbutton href="/user?as={{.User.ID}}">SWAP</a>
    {{end}}

    {{if .You.IsMod}}
    <form method="POST" action="/user" style="display:inline">
        <input type=hidden name=uuid value="{{.ReplyView.UUID}}">
        <input type=hidden name=method value="ban-user">
        <input type=hidden name=ban value="{{if not .User.Banned}}1{{end}}">
        <input type=hidden name=username value="{{.User.ID}}">
        <button class="gbutton" type=submit>{{if .User.Banned}}解封{{else}}封禁{{end}}</button>
    </form>
    {{end}}

    {{if .ReplyView.Error}}
    <div style="display:inline-block">{{template "error_i18n.html" .ReplyView.Error}}</div>
    {{end}}
    </div>

    {{end}}
</div>
{{else if .IsInbox}}
    <title>我的提醒</title>
    <script>sel('#nav-inbox').className = "selected"</script>
{{else if .IsGlobalTimeline}}
    <title>全局时间线</title>
    <script>sel('#nav-master').className = "selected"</script>
{{else}}
<div style="text-align:center;line-height:2em">
        <title>我的时间线</title>
    <div>
        <script>sel('#nav-own').className = "selected"</script>
        <div class="status">
            <div class=title>
                <b>@{{.User.ID}}</b>
                {{if .User.IsMod}}<span class=mod>Mod</span>{{end}}
                {{if .User.Banned}}/ 封禁{{end}}
                <a href="/user"><i class="icon-wrench"></i></a>
            </div>
            <div class=title>
                <a href="/user/blacklist"><i class="icon-block"></i></a>
                &emsp;<b>{{template "kimochi.html" .You}}</b>
                &emsp;{{if .User.Unread}}
                <a href="/t/:in"><b style="color:#f52" class="icon-mail-alt">{{.User.Unread}}</b></a>
                {{else}}
                <a href="/t/:in"><i class="icon-mail-alt"></i></a>
                {{end}}
            </div>
            <span>
                <a href="/user/followings"><b>{{.User.Followings}}</b><br><span style="color:black">关注</span></a>
            </span>
            <span>
                <a href="/user/followers"><b>{{.User.Followers}}</b><br><span style="color:black">粉丝</span></a>
            </span>
            <span>
                <a href="/t/{{.User.ID}}"><b>{{.User.TotalPosts}}</b><br><span style="color:black">状态</span></a>
            </span>
        </div>
    </div>
    {{if .ShowNewPost}}
    <div style="padding:0 0.5em">{{template "reply_view.html" .ReplyView}}</div>
    {{end}}
</div>
        {{end}}

<div class="rows" id=timeline>
    {{if len .Articles}}
    {{range .Articles}}
        {{template "row_content.html" .}}
    {{end}}
    {{else}}
    <div class=row style="text-align:center;padding:1em">无内容</div>
    {{end}}
</div>


<div class=paging>
    {{if .Next}}
    <button value="{{.Next}}" class=gbutton onclick="loadMore(this)">更多...</button>
    <script>
        function loadMore(el) {
            el.setAttribute("disabled", "disabled")
            var tl = sel("#timeline"), waiting = 0;
            var timer = setInterval(function () {
                waiting++;
                el.innerText = "|/-\\|/-\\".charAt(waiting % 8);
            }, 100);

            $post(location.href, 'api=1&cursors=' + encodeURIComponent(el.getAttribute("value")), function(h) {
                clearInterval(timer);
                try {
                    var pl = JSON.parse(h);
                    if (pl.EOT) {
                        el.innerText = "没有更多内容了";
                        el.style.color = "#aaa";
                        el.onclick = function() { location.reload() }
                    } else {
                        el.innerText = "更多...";
                    }
                    if (pl.Articles) {
                        el.setAttribute("value", pl.Next);
                        for (var i = 0; i < pl.Articles.length; i++) {
                            var div = document.createElement("div");
                            div.innerHTML = pl.Articles[i];
                            tl.appendChild(div.firstChild);
                        }
                    }
                } catch (e) {}
                el.removeAttribute("disabled")
                expandNSFW();
            }, function() {
                el.removeAttribute("disabled")
                el.innerText = "重试...";
                clearInterval(timer);
            })

         //   console.log(document.documentElement.scrollTop);
            var rows = sel("#timeline .row");
            for (var i = 0 ; i < rows.length - (window.MAX_ROWS || 100); i++) {
                var c = rows[i];
                if (c.className && c.className.match(/row/) && !c.ERASED) {
                    c.style.height = c.offsetHeight + "px";
                    c.innerHTML = "";
                    c.ERASED = true;
                }
            }
        }

        window.addEventListener('scroll', function(e) {
            if (!window.ticking) {
                window.requestAnimationFrame(function() {
                    var rows = sel("#timeline .row");
                    for (var i = 0 ; i < rows.length; i++) {
                        var c = rows[i];
                        if (isInViewport(c)) {
                            if (c.childNodes.length == 0) {
                                c.innerHTML = c.__html;
                                c.style.height = "";
                            }
                        } else {
                            if (c.childNodes.length) {
                                c.style.height = c.offsetHeight + "px";
                                c.__html = c.innerHTML;
                                c.innerHTML = "";
                            }
                        }
                    }
                    window.ticking = false;
                });
                window.ticking = true;
            }
        });
    </script>
    {{end}}

    {{if not .Next}}
        <a class=gbutton style="color:#aaa"
        {{if .IsUserTimeline}}
            href="/t/{{.User.ID}}">没有更多{{.User.ID}}的状态了</a>
        {{else if .IsInbox}}
            href="/t/:in">没有更多提醒了</a>
        {{else if .IsGlobalTimeline}}
            href="/master">没有更多状态了</a>
        {{else}}
            href="/t">没有更多状态了</a>
        {{end}}
    {{end}}
</div>
