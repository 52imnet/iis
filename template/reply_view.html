<form method="POST" action="{{if .ReplyTo}}/reply{{else}}/new{{end}}">
        {{if .CanDelete}}
    <table class="articles" style="width: 100%;margin:1em 0 2em;box-shadow: 0 1px 3px rgba(0, 0, 0,.2);text-align:left">
        <tr class=sep>
            <td>
                <input type=checkbox name=delete-confirm id=delete-confirm>
                <label for=delete-confirm>确认删除该状态，该操作不可逆</label>
            </td>
            <td class=nowrap>
                <button class="gbutton" type=submit name=delete value=1 style="color:#ff5722">删除</a>
            </td>
        </tr>
        <tr>
            <td>
                <input type=checkbox name=nsfw-confirm id=nsfw-confirm {{if .NSFW}}checked{{end}}>
                <label for=nsfw-confirm>标记该状态为NSFW（仅图片）</label>
            </td>
            <td class=nowrap>
                <button class="gbutton" type=submit name=nsfw value=1 style="color:#f90">标记</a>
            </td>
        </tr>
    </table>
        {{end}}

    <table class="articles" style="width: 100%;margin:1em 0;box-shadow: 0 1px 4px rgba(0, 0, 0,.3);position:relative;text-align:left">

        <tr class=sep>
            <td colspan=2 style="padding:0">
                <input type=hidden name=uuid value="{{.UUID}}">
                <textarea
                    id="content"
                    maxlength=1024
                    placeholder="正文"
                    rows={{if .ReplyTo}}6{{else}}10{{end}}
                    name="content"
                    style="padding:0.5em;border:none">{{.Content}}</textarea>
            </td>
        </tr>
        <tr class=sep>
            <td colspan=2>
                <input type=file id=post-image style="display:none" onchange="onImageChanged(this)">
                <input type=hidden id=post-image-base64 name=image64>
                <a class="gbutton" id=post-image-button onclick="sel('#post-image').click()">
                    <span class=icon-picture></span><span class="pic">图片</span>
                </a>
                <input type=checkbox name=nsfw id=nsfw>
                <label for=nsfw>NSFW</label>
                <script>
                    var pica = window.pica({ features: [ 'js', 'wasm', 'ww', 'cib' ] });

                    function onImageChanged(el) {
                        sel('#post-image-button .pic').innerText = (el.value.split(/(\\|\/)/g).pop() || "图片").substring(0, 16);
                        sel("#post-image-base64").value = "";

                        if (!el.value) return;

                        var reader = new FileReader();
                        reader.readAsDataURL(el.files[0]);
                        reader.onload = function () {
                            var img = new Image();
                            img.onerror = function() {
                                sel('#post-image-button .pic').innerText = "图片";
                            }
                            img.onload = function() {
                                img.onload = null;
                                var canvas = document.createElement("canvas"),
                                    throt = 1 * 1000 * 1000,
                                    f = 1, step = 0.5,
                                    success = function() {
                                        sel("#post-image-base64").value = img.src;
                                        sel("#post-image-button .pic").innerText += " (" + (img.src.length / 1.33 / 1024).toFixed(0) + "KB";
                                        sel("#post-image-button .pic").innerText += (f == 1) ? ")" : " / 缩放" + (100/f).toFixed(0) + "%)";
                                        sel('#reply-submit').removeAttribute("disabled");
                                    },
                                    scaledown = function() {
                                        canvas.width = img.width / f;
                                        canvas.height = img.height / f;
                                        pica.resize(img, canvas, 3).then(function() {
                                            var res = canvas.toDataURL("image/jpeg", 0.75);
                                            console.log(res.length, f);
                                            if (res.length > throt) {
                                                f += step;
                                                step += 0.2;
                                                scaledown();
                                            } else {
                                                img.src = res;
                                                success();
                                            }
                                        });
                                    };

                                sel('#reply-submit').setAttribute("disabled", "disabled");
                                if (img.src.length > throt) {
                                    scaledown();
                                } else {
                                    success();
                                }
                            }
                            img.src = reader.result;
                        };
                    }
                </script>
            </td>
        </tr>
{{if .Error}}
        <tr class=sep style="background:#f1f2f3;cursor:pointer" >
            <td onclick="this.parentNode.style.display='none'" colspan=2>{{template "error_i18n.html" .Error}}</td>
        </tr>
{{end}}
        <tr>
            <td>{{template "emoji.html" .}}</td>
            <td class="nowrap">
                {{if .ReplyTo}}
                <input type=hidden name=reply value="{{.ReplyTo}}">
                <button id=reply-submit class="gbutton" type=submit>回复</button>
                {{else}}
                <button id=reply-submit class="gbutton" type=submit>发布</button>
                {{end}}
            </td>
        </tr>
    </table>
</form>
